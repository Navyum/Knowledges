# Mermaid时序图控制语法完全指南

时序图（Sequence Diagram）是Mermaid中用于展示对象间交互顺序的核心图表类型，而控制语法则是实现复杂流程逻辑（如分支、循环、并行等）的关键。本文将详细介绍Mermaid时序图的5类核心控制块语法，每类均配套易于理解的典型业务场景案例，帮助快速掌握并应用于实际开发文档中。

## 一、基础概念铺垫

在学习控制语法前，先明确时序图的2个基础要素，确保案例可直接运行：

- **参与者（Participant）**：交互的对象，可用`participant`定义（普通对象）或`actor`定义（用户角色），支持别名简化表述。

- **消息流向**：用`->>`表示同步消息（实线带箭头），`-->>`表示异步消息（虚线带箭头），是交互的基础载体。

所有控制块均遵循“**起始关键字+逻辑描述+内容块+end结束**”的统一结构，可嵌套使用实现复杂逻辑。

## 二、核心控制块语法详解

### 1. 抉择控制：alt（条件分支）

**作用**：实现“二选一”或“多选一”的条件分支逻辑，类似编程语言中的`if-else`，适用于存在明确分支条件的交互场景。

#### 语法格式

```mermaid
sequenceDiagram
    参与者A->>参与者B: 发起请求
    alt 分支条件1
        参与者B->>参与者A: 分支1响应
    else 分支条件2
        参与者B->>参与者A: 分支2响应
    end
```

#### 典型案例：用户登录验证

场景：用户输入账号密码后，系统验证凭证有效性，分“验证通过”和“验证失败”两个分支，是最经典的条件交互场景。

```mermaid
sequenceDiagram
    actor 用户
    participant 前端
    participant 后端
    participant 数据库
    
    用户->>前端: 输入账号密码并提交
    前端->>后端: 发送登录请求（含加密凭证）
    后端->>数据库: 查询用户信息并校验
    alt 凭证正确（用户名密码匹配）
        数据库->>后端: 返回用户信息
        后端->>前端: 返回登录成功（含Token）
        前端->>用户: 跳转到首页
    else 凭证错误（用户名或密码错误）
        数据库->>后端: 返回无匹配记录
        后端->>前端: 返回登录失败（错误提示）
        前端->>用户: 显示“账号或密码错误”
    end
```

#### 案例解析

- 分支触发条件：数据库校验凭证的结果，是客观且明确的判断依据。

- 交互完整性：每个分支都包含“请求-处理-响应”的完整链路，符合实际业务流程。

- 语法关键点：`alt`后需标注分支条件，多个分支用`else`分隔，最终用`end`闭合。

### 2. 循环控制：loop（重复执行）

**作用**：实现“满足条件时重复执行”的逻辑，类似`while`循环，适用于定时任务、重试机制等场景。

#### 语法格式

```mermaid
sequenceDiagram
    参与者A->>参与者B: 初始化请求
    loop 循环条件
        参与者A->>参与者B: 循环执行的操作
        参与者B->>参与者A: 操作响应
    end
    参与者A->>参与者B: 循环结束后的操作
```

#### 典型案例：消息重试机制

场景：系统发送消息后未收到响应，触发重试逻辑，最多重试3次，超过则提示失败，是分布式系统中常见的可靠性保障场景。

```mermaid
sequenceDiagram
    participant 订单系统
    participant 支付系统
    participant 消息队列
    
    订单系统->>支付系统: 发送“订单支付成功”消息
    支付系统-->>订单系统: 未响应（网络波动）
    loop 重试次数≤3次
        订单系统->>消息队列: 暂存消息（避免丢失）
        订单系统->>支付系统: 重试发送消息
        alt 重试成功
            支付系统->>订单系统: 确认接收
            订单系统->>消息队列: 删除暂存消息
        else 重试失败
            订单系统->>订单系统: 记录重试次数
        end
    end
    alt 重试3次仍失败
        订单系统->>消息队列: 标记消息为“失败”
        订单系统->>运维系统: 发送告警通知
    end
```

#### 案例解析

- 循环条件明确：以“重试次数≤3次”为终止条件，符合实际业务中的重试策略。

- 嵌套使用：循环内部嵌套`alt`分支判断重试结果，并用`break`实现“成功即退出循环”的逻辑。

- 语法关键点：`loop`后需标注循环条件，循环体内容需完整，用`end`闭合。

### 3. 可选控制：opt（条件执行）

**作用**：实现“满足条件时执行，不满足则跳过”的逻辑，类似单分支`if`，适用于非必需的附加操作场景。

#### 语法格式

```mermaid
sequenceDiagram
    参与者A->>参与者B: 核心请求
    opt 可选条件
        参与者B->>参与者C: 附加操作
        参与者C->>参与者B: 附加操作响应
    end
    参与者B->>参与者A: 核心响应
```

#### 典型案例：订单支付附加优惠

场景：用户支付订单时，若持有优惠券则自动抵扣，无优惠券则直接支付，优惠券抵扣为可选操作，不影响核心支付流程。

```mermaid
sequenceDiagram
    actor 用户
    participant 前端
    participant 支付系统
    participant 优惠券系统
    
    用户->>前端: 提交订单并点击支付
    前端->>支付系统: 发起支付请求（含订单ID）
    opt 用户持有可用优惠券
        支付系统->>优惠券系统: 查询订单可用优惠券
        优惠券系统->>支付系统: 返回可用优惠券（抵扣10元）
        支付系统->>支付系统: 计算实付金额（原价-抵扣）
        支付系统->>前端: 显示“优惠券已抵扣10元”
    end
    前端->>用户: 展示实付金额
    用户->>前端: 确认支付
    前端->>支付系统: 确认支付
    支付系统->>前端: 支付成功
    前端->>用户: 显示支付成功页面
```

#### 案例解析

- 可选性体现：无优惠券时直接跳过优惠券查询流程，不影响核心的支付链路。

- 业务合理性：附加操作（优惠券抵扣）与核心操作（支付）相关联，符合用户实际使用场景。

- 语法关键点：`opt`后标注触发条件，仅当条件满足时执行内部逻辑，用`end`闭合。

### 4. 并行控制：par（同时执行）

**作用**：实现“多个操作同时执行，全部完成后再继续”的逻辑，适用于多模块协同处理的场景。

#### 语法格式

```mermaid
sequenceDiagram
    参与者A->>参与者B: 发起并行请求
    par 并行操作1描述
        参与者A->>参与者C: 操作1
        参与者C->>参与者A: 操作1响应
    and 并行操作2描述
        参与者A->>参与者D: 操作2
        参与者D->>参与者A: 操作2响应
    end
    参与者A->>参与者B: 并行完成后的操作
```

#### 典型案例：APP初始化加载

场景：用户打开APP后，系统同时加载“用户信息”“首页推荐”“消息通知”三个模块，全部加载完成后显示首页，是提升APP启动体验的常见优化场景。

```mermaid
sequenceDiagram
    actor 用户
    participant APP客户端
    participant 用户服务
    participant 推荐服务
    participant 消息服务
    
    用户->>APP客户端: 打开APP
    APP客户端->>APP客户端: 初始化基础配置
    par 加载用户信息
        APP客户端->>用户服务: 请求用户资料
        用户服务->>APP客户端: 返回用户昵称/头像
    and 加载首页推荐
        APP客户端->>推荐服务: 请求个性化推荐
        推荐服务->>APP客户端: 返回推荐内容列表
    and 加载消息通知
        APP客户端->>消息服务: 请求未读消息
        消息服务->>APP客户端: 返回未读消息数
    end
    APP客户端->>APP客户端: 整合所有数据
    APP客户端->>用户: 显示完整首页
```

#### 案例解析

- 并行合理性：三个加载操作相互独立，无依赖关系，适合并行执行以缩短总耗时。

- 同步点清晰：用`end`标记并行操作的结束，确保所有模块加载完成后再展示首页。

- 语法关键点：多个并行操作用`and`分隔，每个操作块可包含完整的交互链路。

### 5. 临界控制：critical（独占执行）

**作用**：实现“资源竞争场景下独占执行”的逻辑，确保同一时间只有一个操作能访问临界资源，适用于库存扣减、余额修改等场景。

#### 语法格式

```mermaid
sequenceDiagram
    参与者A->>参与者B: 请求访问资源
    critical 临界资源描述
        参与者B->>参与者C: 锁定资源
        参与者B->>参与者C: 操作资源
        参与者C->>参与者B: 操作结果
        参与者B->>参与者C: 解锁资源
    option 资源锁定失败
        参与者B->>参与者A: 返回失败提示
    end
    参与者B->>参与者A: 操作响应
```

#### 典型案例：商品库存扣减

场景：双11期间多个用户同时抢购同一商品，需确保库存不超卖，核心是保证库存扣减操作的原子性，是电商系统中的核心并发场景。

```mermaid
sequenceDiagram
    actor 用户A
    actor 用户B
    participant 订单系统
    participant 库存系统
    
    用户A->>订单系统: 抢购商品（库存10件）
    用户B->>订单系统: 抢购商品（同时发起）
    par 用户A抢购流程
        订单系统->>库存系统: 请求扣减库存（1件）
        critical 商品库存资源
            库存系统->>库存系统: 锁定库存记录
            库存系统->>库存系统: 扣减库存（10→9）
            库存系统->>订单系统: 扣减成功
            库存系统->>库存系统: 解锁库存记录
        option 库存锁定失败
            库存系统->>订单系统: 返回“请重试”
        end
        订单系统->>用户A: 抢购成功
    and 用户B抢购流程
        订单系统->>库存系统: 请求扣减库存（1件）
        critical 商品库存资源
            库存系统->>库存系统: 锁定库存记录
            库存系统->>库存系统: 扣减库存（9→8）
            库存系统->>订单系统: 扣减成功
            库存系统->>库存系统: 解锁库存记录
        option 库存锁定失败
            库存系统->>订单系统: 返回“请重试”
        end
        订单系统->>用户B: 抢购成功
    end
```

#### 案例解析

临界资源明确：以“商品库存记录”作为临界资源，锁定后其他请求需等待解锁，避免超卖。失败处理：通过`option`定义锁定失败的降级策略（提示重试），增强系统稳定性。语法关键点：`critical`后标注临界资源，内部包含“锁定-操作-解锁”的原子化流程。

## 三、控制块嵌套使用规则

实际业务场景往往需要多控制逻辑组合，嵌套使用需遵循“内层控制块完全包含于外层控制块”的原则，以下为常见嵌套场景示例：

```mermaid
sequenceDiagram
    actor 用户
    participant 前端
    participant 后端
    participant 数据库
    
    用户->>前端: 提交表单
    前端->>后端: 提交数据
    loop 数据验证未通过（最多3次）
        alt 格式错误
            后端->>前端: 返回格式错误提示
            前端->>用户: 显示错误并允许修改
            用户->>前端: 修正数据并提交
            前端->>后端: 重新提交数据
        else 重复数据
            后端->>数据库: 校验唯一性
            数据库->>后端: 返回重复提示
            后端->>前端: 提示“数据已存在”
        end
    end
    后端->>数据库: 保存数据
    后端->>前端: 提交成功
    前端->>用户: 显示成功页面
```

## 四、语法速查表

|控制块类型|核心关键字|核心作用|典型场景|
|---|---|---|---|
|抉择控制|alt + else + end|多条件分支|登录验证、权限判断|
|循环控制|loop + end|重复执行|消息重试、定时任务|
|可选控制|opt + end|条件执行（单分支）|优惠券抵扣、附加服务|
|并行控制|par + and + end|多操作同时执行|APP初始化、多模块查询|
|临界控制|critical + option + end|独占访问资源|库存扣减、余额修改|
## 五、工具推荐与验证方法

- **在线编辑器**：Mermaid Live Editor（[https://mermaid.live/](https://mermaid.live/)），支持实时编写和渲染，语法错误会自动提示。

- **IDE插件**：VS Code安装“Markdown Preview Mermaid Support”插件，可在Markdown文档中预览时序图。

- **验证技巧**：复杂逻辑建议先拆解为单个控制块验证，再逐步嵌套组合，避免因嵌套层级过多导致语法错误。