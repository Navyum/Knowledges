"use strict";(self.webpackChunknavyum_blog=self.webpackChunknavyum_blog||[]).push([[73517],{36995:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,e]of s)a[n]=e;return a}},97180:(n,s,a)=>{a.r(s),a.d(s,{comp:()=>l,data:()=>p});var e=a(6254);const i={},l=(0,a(36995).A)(i,[["render",function(n,s){return(0,e.uX)(),(0,e.CE)("div",null,s[0]||(s[0]=[(0,e.Fv)('<h2 id="wireshark抓包" tabindex="-1"><a class="header-anchor" href="#wireshark抓包"><span>wireshark抓包</span></a></h2><h3 id="sni问题导致的网关层返回502错误" tabindex="-1"><a class="header-anchor" href="#sni问题导致的网关层返回502错误"><span>SNI问题导致的网关层返回502错误</span></a></h3><hr><h3 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景：</span></a></h3><p>最近攻防等原因，运维将测试环境部分域名上了cloudflare（主要是海外）</p><h3 id="业务方出现的问题" tabindex="-1"><a class="header-anchor" href="#业务方出现的问题"><span>业务方出现的问题：</span></a></h3><p>在nginx中，这些域名被用做反向代理的upstream，在添加cloudflare之后，访问出现 http 502，具体配置如下</p><h3 id="出错的nginx配置" tabindex="-1"><a class="header-anchor" href="#出错的nginx配置"><span>出错的nginx配置</span></a></h3><div class="language-nginx.conf line-numbers-mode" data-highlighter="shiki" data-ext="nginx.conf" data-title="nginx.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>location /proxy/cn/</span></span>\n<span class="line"><span>{</span></span>\n<span class="line"><span>    proxy_pass https://user_cs_cn_backend/;</span></span>\n<span class="line"><span>    proxy_http_version 1.1;</span></span>\n<span class="line"><span>    proxy_set_header Host &quot;api-cs-cn-sandbox.intsig.net&quot;;</span></span>\n<span class="line"><span>    proxy_set_header Connection &quot;keep-alive&quot;;</span></span>\n<span class="line"><span>    proxy_connect_timeout 5;</span></span>\n<span class="line"><span>    proxy_send_timeout 10;</span></span>\n<span class="line"><span>    proxy_read_timeout 10;</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-backend.conf line-numbers-mode" data-highlighter="shiki" data-ext="backend.conf" data-title="backend.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>upstream user_cs_cn_backend {</span></span>\n<span class="line"><span>    server api-cs-cn-sandbox.intsig.net:443;</span></span>\n<span class="line"><span>    keepalive 100;</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="最终定位到原因" tabindex="-1"><a class="header-anchor" href="#最终定位到原因"><span>最终定位到原因：</span></a></h3><p>直接原因：跟cloudflare层的SSL握手失败 根本原因：nginx的配置错误、nginx本身没有正确处理SNI</p><h3 id="如何解决" tabindex="-1"><a class="header-anchor" href="#如何解决"><span>如何解决：</span></a></h3><p>在反向代理层添加</p><div class="language-nginx.conf line-numbers-mode" data-highlighter="shiki" data-ext="nginx.conf" data-title="nginx.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>location  /proxy/cn/ {</span></span>\n<span class="line"><span>...</span></span>\n<span class="line"><span>proxy_ssl_server_name on;</span></span>\n<span class="line"><span>proxy_ssl_name &quot;upstream-domain-name&quot;;</span></span>\n<span class="line"><span>...</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分析过程" tabindex="-1"><a class="header-anchor" href="#分析过程"><span>分析过程：</span></a></h3><ol><li><p>复现问题：</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/948a66b5573e0091700f8bdc3696a561.png" width="80%"></p></li><li><p>查看域名解析情况：</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/46a1f13e9f01859b312094dfa5fbe24b.png" width="80%"></p></li><li><p>通过tcpdump进行抓包，在wireshark中打开</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/7c6e0c2d6131e36333e8c24a35cdefb8.png" width="80%"></p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/517590ec728251d6e3c2cc816e4a26e2.png" width="80%"></p></li><li><p>查看详细失败：</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/4f15c3123bfaa068f9dc582112407e3b.png" width="80%"></p></li><li><p>TLS握手失败错误码 40解读：</p><ul><li>根本原因是 SNI 缺失，因为nginx在反向代理时，如果使用的是负载均衡的backend，默认会把host值、SNI传成backend的名称（user_cs_cn_backend），而不是真实的域名（巨坑）。</li><li>SNI解读： <ul><li>SNI（Server Name Indication）允许客户端在TLS握手时指定要访问的域名，这样服务器可以返回正确的证书。</li><li>SNI使用场景：共享 IP 端口的多域名 HTTPS 服务（如虚拟主机）。例如：云服务商通过一个 IP 提供多个客户的 HTTPS 域名服务，用 SNI 区分证书，作用在TLS握手时，所以加上HTTP层的HOST，对SNI是无法生效的。</li><li>在反向代理中，如果后端服务（网关）使用不同的域名（<strong>网关需要设置为多个域名对应一个公网ip</strong>），代理服务器必须正确传递SNI信息，否则后端可能无法识别请求，导致握手失败。</li></ul></li><li>基于这个原因，有两种处理方式： <ol><li>不使用backend做负载均衡，而是直接写成对应域名。一般开发、测试环境可以这样操作。<div class="language-nginx.conf line-numbers-mode" data-highlighter="shiki" data-ext="nginx.conf" data-title="nginx.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>     location /proxy/cn/</span></span>\n<span class="line"><span>     {</span></span>\n<span class="line"><span>         proxy_pass https://api-cs-cn-sandbox.intsig.net/;</span></span>\n<span class="line"><span>         proxy_http_version 1.1;</span></span>\n<span class="line"><span>         proxy_set_header Connection &quot;keep-alive&quot;;</span></span>\n<span class="line"><span>         proxy_connect_timeout 5;</span></span>\n<span class="line"><span>         proxy_send_timeout 10;</span></span>\n<span class="line"><span>         proxy_read_timeout 10;</span></span>\n<span class="line"><span>     }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>设置正确的SNI信息，proxy_ssl_server_name、proxy_ssl_name。如果涉及backend存在多个域名，则需要结合map、变量，来设置proxy_ssl_name。<div class="language-nginx.conf line-numbers-mode" data-highlighter="shiki" data-ext="nginx.conf" data-title="nginx.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>location  /proxy/cn/ {</span></span>\n<span class="line"><span>...</span></span>\n<span class="line"><span>proxy_ssl_server_name on;</span></span>\n<span class="line"><span>proxy_ssl_name &quot;upstream-domain-name&quot;;</span></span>\n<span class="line"><span>...</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol></li></ul></li></ol>',17)]))}]]),p=JSON.parse('{"path":"/%E5%B7%A5%E5%85%B7%E6%AD%A6%E5%99%A8%E5%BA%93/%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85Wireshark/wireshark%E6%8A%93%E5%8C%85%E4%B9%8BSSL%E6%8F%A1%E6%89%8B%E9%97%AE%E9%A2%98.html","title":"wireshark抓包-SSL握手","lang":"zh-CN","frontmatter":{"title":"wireshark抓包-SSL握手","date":"2025-03-28T15:11:25.000Z","author":"Navyum","icon":"lucide-lab:shark","tags":["抓包","网络分析","TSL握手失败","wireshark"],"categories":["wireshark","工具"],"article":true,"index":true,"headerDepth":2,"sticky":true,"star":true,"description":"wireshark抓包 SNI问题导致的网关层返回502错误 背景： 最近攻防等原因，运维将测试环境部分域名上了cloudflare（主要是海外） 业务方出现的问题： 在nginx中，这些域名被用做反向代理的upstream，在添加cloudflare之后，访问出现 http 502，具体配置如下 出错的nginx配置 最终定位到原因： 直接原因：跟c...","head":[["meta",{"property":"og:url","content":"https://myblog.camscanner.top/%E5%B7%A5%E5%85%B7%E6%AD%A6%E5%99%A8%E5%BA%93/%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85Wireshark/wireshark%E6%8A%93%E5%8C%85%E4%B9%8BSSL%E6%8F%A1%E6%89%8B%E9%97%AE%E9%A2%98.html"}],["meta",{"property":"og:site_name","content":"Navyum\'s Blog"}],["meta",{"property":"og:title","content":"wireshark抓包-SSL握手"}],["meta",{"property":"og:description","content":"wireshark抓包 SNI问题导致的网关层返回502错误 背景： 最近攻防等原因，运维将测试环境部分域名上了cloudflare（主要是海外） 业务方出现的问题： 在nginx中，这些域名被用做反向代理的upstream，在添加cloudflare之后，访问出现 http 502，具体配置如下 出错的nginx配置 最终定位到原因： 直接原因：跟c..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-11T08:58:50.000Z"}],["meta",{"property":"article:author","content":"Navyum"}],["meta",{"property":"article:tag","content":"抓包"}],["meta",{"property":"article:tag","content":"网络分析"}],["meta",{"property":"article:tag","content":"TSL握手失败"}],["meta",{"property":"article:tag","content":"wireshark"}],["meta",{"property":"article:published_time","content":"2025-03-28T15:11:25.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-11T08:58:50.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"wireshark抓包-SSL握手\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-03-28T15:11:25.000Z\\",\\"dateModified\\":\\"2025-08-11T08:58:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Navyum\\"}]}"]]},"git":{"createdTime":1749983452000,"updatedTime":1754902730000,"contributors":[{"name":"Navyum","username":"Navyum","email":"36869790+Navyum@users.noreply.github.com","commits":1,"url":"https://github.com/Navyum"},{"name":"haijun_yang","username":"haijun_yang","email":"haijun_yang@intsig.net","commits":4,"url":"https://github.com/haijun_yang"}]},"readingTime":{"minutes":2.29,"words":688},"filePathRelative":"工具武器库/网络抓包Wireshark/wireshark抓包之SSL握手问题.md","localizedDate":"2025年3月28日","excerpt":"<h2>wireshark抓包</h2>\\n<h3>SNI问题导致的网关层返回502错误</h3>\\n<hr>\\n<h3>背景：</h3>\\n<p>最近攻防等原因，运维将测试环境部分域名上了cloudflare（主要是海外）</p>\\n<h3>业务方出现的问题：</h3>\\n<p>在nginx中，这些域名被用做反向代理的upstream，在添加cloudflare之后，访问出现 http 502，具体配置如下</p>\\n<h3>出错的nginx配置</h3>\\n<div class=\\"language-nginx.conf line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"nginx.conf\\" data-title=\\"nginx.conf\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span>location /proxy/cn/</span></span>\\n<span class=\\"line\\"><span>{</span></span>\\n<span class=\\"line\\"><span>    proxy_pass https://user_cs_cn_backend/;</span></span>\\n<span class=\\"line\\"><span>    proxy_http_version 1.1;</span></span>\\n<span class=\\"line\\"><span>    proxy_set_header Host \\"api-cs-cn-sandbox.intsig.net\\";</span></span>\\n<span class=\\"line\\"><span>    proxy_set_header Connection \\"keep-alive\\";</span></span>\\n<span class=\\"line\\"><span>    proxy_connect_timeout 5;</span></span>\\n<span class=\\"line\\"><span>    proxy_send_timeout 10;</span></span>\\n<span class=\\"line\\"><span>    proxy_read_timeout 10;</span></span>\\n<span class=\\"line\\"><span>}</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}')}}]);