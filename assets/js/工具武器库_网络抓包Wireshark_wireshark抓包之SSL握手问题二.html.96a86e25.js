"use strict";(self.webpackChunknavyum_blog=self.webpackChunknavyum_blog||[]).push([[63345],{36995:(s,i)=>{i.A=(s,i)=>{const a=s.__vccOpts||s;for(const[s,n]of i)a[s]=n;return a}},67256:(s,i,a)=>{a.r(i),a.d(i,{comp:()=>t,data:()=>r});var n=a(6254);const e={},t=(0,a(36995).A)(e,[["render",function(s,i){return(0,n.uX)(),(0,n.CE)("div",null,i[0]||(i[0]=[(0,n.Fv)('<h2 id="wireshark抓包" tabindex="-1"><a class="header-anchor" href="#wireshark抓包"><span>wireshark抓包</span></a></h2><h3 id="证书过期问题导致的网关层返回502错误" tabindex="-1"><a class="header-anchor" href="#证书过期问题导致的网关层返回502错误"><span>证书过期问题导致的网关层返回502错误</span></a></h3><hr><h3 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景：</span></a></h3><p>新对接的新服务，在nginx上配置为反向代理upstream进行访问</p><h3 id="业务方出现的问题" tabindex="-1"><a class="header-anchor" href="#业务方出现的问题"><span>业务方出现的问题：</span></a></h3><p>访问时稳定复现502错误，但是使用curl则正常。nginx配置如下：</p><h3 id="出错的nginx配置" tabindex="-1"><a class="header-anchor" href="#出错的nginx配置"><span>出错的nginx配置</span></a></h3><div class="language-nginx.conf line-numbers-mode" data-highlighter="shiki" data-ext="nginx.conf" data-title="nginx.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>location /test</span></span>\n<span class="line"><span>{</span></span>\n<span class="line"><span>    proxy_pass https://middleground_workonly_backend/xxx/xxx;</span></span>\n<span class="line"><span>    proxy_http_version 1.1;</span></span>\n<span class="line"><span>    proxy_set_header Host &quot;xxx-sandbox-workonly.xxx.xxx&quot;;</span></span>\n<span class="line"><span>    proxy_set_header Connection &quot;keep-alive&quot;;</span></span>\n<span class="line"><span>    proxy_connect_timeout 5;</span></span>\n<span class="line"><span>    proxy_send_timeout 10;</span></span>\n<span class="line"><span>    proxy_read_timeout 10;</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-backend.conf line-numbers-mode" data-highlighter="shiki" data-ext="backend.conf" data-title="backend.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>upstream middleground_workonly_backend {</span></span>\n<span class="line"><span>    server xxx-sandbox-workonly.xxx.xxx:443;</span></span>\n<span class="line"><span>    keepalive 100;</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="最终定位到原因" tabindex="-1"><a class="header-anchor" href="#最终定位到原因"><span>最终定位到原因：</span></a></h3><p>直接原因：SSL握手校验不通过，导致握手失败 根本原因：服务端的证书过期</p><h3 id="如何解决" tabindex="-1"><a class="header-anchor" href="#如何解决"><span>如何解决：</span></a></h3><p>更新证书有效期</p><h3 id="分析过程" tabindex="-1"><a class="header-anchor" href="#分析过程"><span>分析过程：</span></a></h3><ol><li><p>复现问题：</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/567b0cd154d0ac2ed69d1d9b06dbb265.png" width="80%"></p></li><li><p>查看域名解析情况：</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/70a5358e761ebb8c11e611713d5eef22.png" width="80%"></p></li><li><p>通过tcpdump进行抓包，在wireshark中打开</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/a5d1a947bf4baba12c9be63539174ed9.png" width="80%"></p></li><li><p>查看详细失败：</p><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/3f57168739ae9cea17e33cebca34d773.png" width="80%"></p></li><li><p>TLS握手失败错误码 80 解读：</p><ul><li>Internal Error：服务端内部错误。这个错误比较坑的地方就是，过于通用，没有给到具体错误位置。</li><li>错误一般是： <ul><li>证书问题</li><li>握手协议不匹配</li><li>无法协商密钥套件</li><li>缺少必要信息例如SNI的server_name等</li></ul></li><li>官方解释：<a href="https://www.ietf.org/rfc/rfc5246.txt" target="_blank" rel="noopener noreferrer">RFC</a><blockquote><p>internal_error： An internal error unrelated to the peer or the correctness of the protocol (such as a memory allocation failure) makes it impossible to continue. This message is always fatal.</p></blockquote></li></ul></li><li><p>进一步获取关键错误信息： 使用SSL大杀器<strong>openssl</strong>查看握手详细信息：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #查看SSL/TSL握手信息</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> s_client</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -connect</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> domain:443</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -debug</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/4d2a758cf46139dfa3d0dddd480b38bf.png" width="80%"></p><p>使用openssl解析证书查看有效期：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #查看证书校验信息  -noout 不输出证书内容</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> s_client</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -connect</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> domain:443</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -servername</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> domain</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> x509</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -noout</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -dates</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/bb156771d79dc6cc33054eb5ec11f759.png" width="80%"></p><p>最终确定证书已经过期！！</p></li></ol>',16)]))}]]),r=JSON.parse('{"path":"/%E5%B7%A5%E5%85%B7%E6%AD%A6%E5%99%A8%E5%BA%93/%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85Wireshark/wireshark%E6%8A%93%E5%8C%85%E4%B9%8BSSL%E6%8F%A1%E6%89%8B%E9%97%AE%E9%A2%98%E4%BA%8C.html","title":"wireshark抓包-SSL握手","lang":"zh-CN","frontmatter":{"title":"wireshark抓包-SSL握手","date":"2025-03-28T15:11:25.000Z","author":"Navyum","icon":"lucide-lab:shark","tags":["抓包","网络问题分析","TSL握手失败","wireshark抓包"],"categories":["wireshark","工具"],"article":true,"index":true,"headerDepth":2,"sticky":true,"star":true,"description":"wireshark抓包 证书过期问题导致的网关层返回502错误 背景： 新对接的新服务，在nginx上配置为反向代理upstream进行访问 业务方出现的问题： 访问时稳定复现502错误，但是使用curl则正常。nginx配置如下： 出错的nginx配置 最终定位到原因： 直接原因：SSL握手校验不通过，导致握手失败 根本原因：服务端的证书过期 如何解...","head":[["meta",{"property":"og:url","content":"https://myblog.camscanner.top/%E5%B7%A5%E5%85%B7%E6%AD%A6%E5%99%A8%E5%BA%93/%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85Wireshark/wireshark%E6%8A%93%E5%8C%85%E4%B9%8BSSL%E6%8F%A1%E6%89%8B%E9%97%AE%E9%A2%98%E4%BA%8C.html"}],["meta",{"property":"og:site_name","content":"Navyum\'s Blog"}],["meta",{"property":"og:title","content":"wireshark抓包-SSL握手"}],["meta",{"property":"og:description","content":"wireshark抓包 证书过期问题导致的网关层返回502错误 背景： 新对接的新服务，在nginx上配置为反向代理upstream进行访问 业务方出现的问题： 访问时稳定复现502错误，但是使用curl则正常。nginx配置如下： 出错的nginx配置 最终定位到原因： 直接原因：SSL握手校验不通过，导致握手失败 根本原因：服务端的证书过期 如何解..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-11T08:58:50.000Z"}],["meta",{"property":"article:author","content":"Navyum"}],["meta",{"property":"article:tag","content":"抓包"}],["meta",{"property":"article:tag","content":"网络问题分析"}],["meta",{"property":"article:tag","content":"TSL握手失败"}],["meta",{"property":"article:tag","content":"wireshark抓包"}],["meta",{"property":"article:published_time","content":"2025-03-28T15:11:25.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-11T08:58:50.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"wireshark抓包-SSL握手\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-03-28T15:11:25.000Z\\",\\"dateModified\\":\\"2025-08-11T08:58:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Navyum\\"}]}"]]},"git":{"createdTime":1749983452000,"updatedTime":1754902730000,"contributors":[{"name":"Navyum","username":"Navyum","email":"36869790+Navyum@users.noreply.github.com","commits":1,"url":"https://github.com/Navyum"},{"name":"haijun_yang","username":"haijun_yang","email":"haijun_yang@intsig.net","commits":5,"url":"https://github.com/haijun_yang"}]},"readingTime":{"minutes":1.74,"words":522},"filePathRelative":"工具武器库/网络抓包Wireshark/wireshark抓包之SSL握手问题二.md","localizedDate":"2025年3月28日","excerpt":"<h2>wireshark抓包</h2>\\n<h3>证书过期问题导致的网关层返回502错误</h3>\\n<hr>\\n<h3>背景：</h3>\\n<p>新对接的新服务，在nginx上配置为反向代理upstream进行访问</p>\\n<h3>业务方出现的问题：</h3>\\n<p>访问时稳定复现502错误，但是使用curl则正常。nginx配置如下：</p>\\n<h3>出错的nginx配置</h3>\\n<div class=\\"language-nginx.conf line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"nginx.conf\\" data-title=\\"nginx.conf\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span>location /test</span></span>\\n<span class=\\"line\\"><span>{</span></span>\\n<span class=\\"line\\"><span>    proxy_pass https://middleground_workonly_backend/xxx/xxx;</span></span>\\n<span class=\\"line\\"><span>    proxy_http_version 1.1;</span></span>\\n<span class=\\"line\\"><span>    proxy_set_header Host \\"xxx-sandbox-workonly.xxx.xxx\\";</span></span>\\n<span class=\\"line\\"><span>    proxy_set_header Connection \\"keep-alive\\";</span></span>\\n<span class=\\"line\\"><span>    proxy_connect_timeout 5;</span></span>\\n<span class=\\"line\\"><span>    proxy_send_timeout 10;</span></span>\\n<span class=\\"line\\"><span>    proxy_read_timeout 10;</span></span>\\n<span class=\\"line\\"><span>}</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}')}}]);