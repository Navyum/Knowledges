"use strict";(self.webpackChunknavyum_blog=self.webpackChunknavyum_blog||[]).push([[71882],{36995:(e,s)=>{s.A=(e,s)=>{const n=e.__vccOpts||e;for(const[e,a]of s)n[e]=a;return n}},80645:(e,s,n)=>{n.r(s),n.d(s,{comp:()=>t,data:()=>r});var a=n(6254);const i={},t=(0,n(36995).A)(i,[["render",function(e,s){return(0,a.uX)(),(0,a.CE)("div",null,s[0]||(s[0]=[(0,a.Fv)('<h2 id="wireshark抓包" tabindex="-1"><a class="header-anchor" href="#wireshark抓包"><span>wireshark抓包</span></a></h2><h3 id="nginx-负载均衡导致的400错误" tabindex="-1"><a class="header-anchor" href="#nginx-负载均衡导致的400错误"><span>nginx 负载均衡导致的400错误</span></a></h3><hr><h3 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景：</span></a></h3><p>因为转换服务比较耗CPU等资源，业务层针对pdf转offcie服务做负载均衡</p><h3 id="出现问题" tabindex="-1"><a class="header-anchor" href="#出现问题"><span>出现问题：</span></a></h3><p>未做负载均衡前，一切正常；添加负载均衡之后反而失败了</p><h3 id="出错的nginx配置" tabindex="-1"><a class="header-anchor" href="#出错的nginx配置"><span>出错的nginx配置</span></a></h3><div class="language-nginx.conf line-numbers-mode" data-highlighter="shiki" data-ext="nginx.conf" data-title="nginx.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>location /aspose_sdk/</span></span>\n<span class="line"><span>{</span></span>\n<span class="line"><span>    client_body_buffer_size 30M;</span></span>\n<span class="line"><span>    client_max_body_size 30M;</span></span>\n<span class="line"><span>    proxy_pass http://aspose_sdk/;</span></span>\n<span class="line"><span>    proxy_set_header Connection &quot;&quot;;</span></span>\n<span class="line"><span>    proxy_http_version 1.0;</span></span>\n<span class="line"><span>    proxy_connect_timeout 10;</span></span>\n<span class="line"><span>    proxy_send_timeout 30;</span></span>\n<span class="line"><span>    proxy_read_timeout 300;</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-backend.conf line-numbers-mode" data-highlighter="shiki" data-ext="backend.conf" data-title="backend.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>upstream aspose_sdk {</span></span>\n<span class="line"><span>    server 10.2.7.228:9081;</span></span>\n<span class="line"><span>    server 10.2.7.229:9081;</span></span>\n<span class="line"><span>    keepalive 10;</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="最终定位到原因" tabindex="-1"><a class="header-anchor" href="#最终定位到原因"><span>最终定位到原因：</span></a></h3><p>直接原因：上游的aspose服务spring boot使用的是tomcat的网络框架，对host校验规则存在一些问题，不支持下划线。附<a href="https://github.com/spring-projects/spring-boot/issues/13236" target="_blank" rel="noopener noreferrer">issue</a> 根本原因：nginx本身使用的backend别名作为Host name，没有正确处理host。（在不设置proxy_set_header的情况下，默认为 <code>proxy_set_header $proxy_host</code>）</p><h3 id="分析过程" tabindex="-1"><a class="header-anchor" href="#分析过程"><span>分析过程：</span></a></h3><ol><li>复现问题：</li></ol><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/6a47790d218ab48980a42da6b727d9a7.png" width="80%"></p> 2. 通过tcpdump进行抓包，在wireshark中打开 * 请求失败400 <p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/fe3f14217fb139fff3aa4318ae06a554.png" width="80%"></p> * 请求头信息 <p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/99522b1c9e8360f7f04775fe5583d6c9.png" width="80%"></p> * 正常的请求头信息 <p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/43cabc80eb46e25ee5f2639385e43285.png" width="80%"></p><ol start="3"><li><p>解析抓包结果：</p><ol><li>根据错误码4XX，初步可以断定是客户端（请求端）的问题</li><li>客户端问题，一般可以逐个分析请求头、请求体等信息是否正确，例如HTTP/1.1 强制要求必须要有Host头等等</li><li>对比分析正常、异常的抓包请求，分析差异点（关键步骤）</li><li>最终发现仅Host存在差异。此时可以进行实验操作，对Host进行修改再测试，最终发现是Host不正确，被nginx使用成了backend的名称aspose_sdk。 相关资料：<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" target="_blank" rel="noopener noreferrer">nginx 官方文档</a><p align="center"><img src="https://raw.staticdn.net/Navyum/imgbed/pic/IMG/accb47cd32248ea3c59922964d60872b.png" width="80%"></p></li></ol></li><li><p>解决方案：</p><ol><li>将upstream的名称去除下划线_，aspose_sdk改为asposeSdk <ul><li>主要是因为上游服务使用的是Springboot Tomcat历史版本问题</li><li>说明：https://github.com/spring-projects/spring-boot/issues/13236</li></ul></li><li>设置正确的Host，<code>proxy_set_header HOST $host</code><ul><li>设置为正常的Host（虽然大多时候没啥问题，出问题可难排查）</li></ul></li></ol></li></ol><h3 id="延伸" tabindex="-1"><a class="header-anchor" href="#延伸"><span>延伸：</span></a></h3><ol><li>nginx 在使用upstream时，命名最好不要带符号和数字（避免出现问题）</li><li>设置正确的Host（做好规范）</li><li>proxy_set_header的用法 <ul><li><code>proxy_set_header HOST $host</code>：用户请求中的Host字段，不带端口</li><li><code>proxy_set_header HOST $http_host</code>：用户请求中的Host字段，带端口</li><li><code>proxy_set_header HOST $proxy_host</code>：反向代理中设置的上游的主机名</li></ul></li></ol>',24)]))}]]),r=JSON.parse('{"path":"/%E5%B7%A5%E5%85%B7%E6%AD%A6%E5%99%A8%E5%BA%93/%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85Wireshark/wireshark%E6%8A%93%E5%8C%85%E4%B9%8BHost%E6%A0%A1%E9%AA%8C%E7%9A%84%E5%BC%82%E5%B8%B8.html","title":"wireshark抓包-Host校验的异常","lang":"zh-CN","frontmatter":{"title":"wireshark抓包-Host校验的异常","date":"2025-03-28T15:11:11.000Z","author":"Navyum","icon":"lucide-lab:shark","tags":["wireshark","抓包","tomcat"],"categories":["wireshark","工具"],"article":true,"index":true,"headerDepth":2,"sticky":true,"star":true,"description":"wireshark抓包 nginx 负载均衡导致的400错误 背景： 因为转换服务比较耗CPU等资源，业务层针对pdf转offcie服务做负载均衡 出现问题： 未做负载均衡前，一切正常；添加负载均衡之后反而失败了 出错的nginx配置 最终定位到原因： 直接原因：上游的aspose服务spring boot使用的是tomcat的网络框架，对host校验...","head":[["meta",{"property":"og:url","content":"https://myblog.camscanner.top/%E5%B7%A5%E5%85%B7%E6%AD%A6%E5%99%A8%E5%BA%93/%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85Wireshark/wireshark%E6%8A%93%E5%8C%85%E4%B9%8BHost%E6%A0%A1%E9%AA%8C%E7%9A%84%E5%BC%82%E5%B8%B8.html"}],["meta",{"property":"og:site_name","content":"Navyum\'s Blog"}],["meta",{"property":"og:title","content":"wireshark抓包-Host校验的异常"}],["meta",{"property":"og:description","content":"wireshark抓包 nginx 负载均衡导致的400错误 背景： 因为转换服务比较耗CPU等资源，业务层针对pdf转offcie服务做负载均衡 出现问题： 未做负载均衡前，一切正常；添加负载均衡之后反而失败了 出错的nginx配置 最终定位到原因： 直接原因：上游的aspose服务spring boot使用的是tomcat的网络框架，对host校验..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-06-23T09:35:21.000Z"}],["meta",{"property":"article:author","content":"Navyum"}],["meta",{"property":"article:tag","content":"wireshark"}],["meta",{"property":"article:tag","content":"抓包"}],["meta",{"property":"article:tag","content":"tomcat"}],["meta",{"property":"article:published_time","content":"2025-03-28T15:11:11.000Z"}],["meta",{"property":"article:modified_time","content":"2025-06-23T09:35:21.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"wireshark抓包-Host校验的异常\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-03-28T15:11:11.000Z\\",\\"dateModified\\":\\"2025-06-23T09:35:21.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Navyum\\"}]}"]]},"git":{"createdTime":1749983452000,"updatedTime":1750671321000,"contributors":[{"name":"Navyum","username":"Navyum","email":"36869790+Navyum@users.noreply.github.com","commits":1,"url":"https://github.com/Navyum"},{"name":"haijun_yang","username":"haijun_yang","email":"haijun_yang@intsig.net","commits":3,"url":"https://github.com/haijun_yang"}]},"readingTime":{"minutes":2.21,"words":662},"filePathRelative":"工具武器库/网络抓包Wireshark/wireshark抓包之Host校验的异常.md","localizedDate":"2025年3月28日","excerpt":"<h2>wireshark抓包</h2>\\n<h3>nginx 负载均衡导致的400错误</h3>\\n<hr>\\n<h3>背景：</h3>\\n<p>因为转换服务比较耗CPU等资源，业务层针对pdf转offcie服务做负载均衡</p>\\n<h3>出现问题：</h3>\\n<p>未做负载均衡前，一切正常；添加负载均衡之后反而失败了</p>\\n<h3>出错的nginx配置</h3>\\n<div class=\\"language-nginx.conf line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"nginx.conf\\" data-title=\\"nginx.conf\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span>location /aspose_sdk/</span></span>\\n<span class=\\"line\\"><span>{</span></span>\\n<span class=\\"line\\"><span>    client_body_buffer_size 30M;</span></span>\\n<span class=\\"line\\"><span>    client_max_body_size 30M;</span></span>\\n<span class=\\"line\\"><span>    proxy_pass http://aspose_sdk/;</span></span>\\n<span class=\\"line\\"><span>    proxy_set_header Connection \\"\\";</span></span>\\n<span class=\\"line\\"><span>    proxy_http_version 1.0;</span></span>\\n<span class=\\"line\\"><span>    proxy_connect_timeout 10;</span></span>\\n<span class=\\"line\\"><span>    proxy_send_timeout 30;</span></span>\\n<span class=\\"line\\"><span>    proxy_read_timeout 300;</span></span>\\n<span class=\\"line\\"><span>}</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}')}}]);